#!/usr/bin/env node

const newsInfoRepository = require("../models/newsInfo/repository");
const connectDB = require("../utility/connectDB");
const { today } = require("../utility/dateTime");
const config = require("../utility/config");
const puppeteer = require("puppeteer");

//增資、合併、訂單、設廠、利多消息

(async () => {
  const link = "https://udn.com/news/index";
  const keyWord = "現金股利";
  const chromeOptions = {
    // headless: true, // run in a non-headless mode
    // args: ["--incognito", "--no-sandbox", "--single-process", "--no-zygote"],
    // defaultViewport: null,
    // slowMo: 100, // slows down Puppeteer operation
    headless: false,
  };

  const browser = await puppeteer.launch(chromeOptions);
  const page = await browser.newPage();
  await page.exposeFunction("getToday", () => {
    return today();
  });
  await page.exposeFunction("writeLog", (text) => {
    console.log(text);
  });
  await page.exposeFunction("keyWord", (text) => {
    console.log(text);
  });

  await page.setDefaultNavigationTimeout(70000);
  console.log("go to page");
  await page.goto(link);
  await page.waitForSelector(".menu-toggler.search");
  await page.click(".menu-toggler.search");
  console.log("start search");
  await page.type('.overlay-menu input[type="search"]', keyWord, {
    delay: 150,
  });
  await page.click('.overlay-menu [aria-label="submit-search"]');
  await page.waitForSelector(".menu-toggler.search");
  await page.waitForSelector(".search-total");
  //document.getElementById("indicator").scrollIntoView();
  console.log("start get data");

  const data = await page.evaluate(async () => {
    const todayStr = await window.getToday();
    const keyWord = await window.keyWord;
    window.writeLog("inside evaluate today" + todayStr);

    const temp = [];
    document
      .querySelectorAll(".story-list__news:not(.feature-guess__list)") //
      .forEach((node) => {
        const link = node.querySelector("a").getAttribute("href");
        const key = link.split("/").pop();
        const title = node.querySelector("a").getAttribute("aria-label");
        const time = node.querySelector("time").textContent; //2021-07-29 16:36:10
        if (todayStr == time.replace(/\D/g, "").substr(0, 8)) {
          temp.push({
            category: keyWord,
            key,
            title,
            link,
            time,
            updateDate: todayStr,
          });
        }
      });

    return temp;
  });

  await connectDB.toMongo(config.MONGODB_URI); //"mongodb+srv://user:P@ssw0rd@cluster0.qeuns.gcp.mongodb.net/<dbname>?retryWrites=true&w=majority"

  const existData = await newsInfoRepository.getData({ updateDate: today() });

  const newData = data.filter((x) => !existData.find((y) => y.key == x.key));

  await newsInfoRepository.saveData(newData);

  console.log("save data done", existData.length, data.length, newData.length);
  process.exit(1);
})();
